@{
    ViewData["Title"] = "Manage Sections";
}

<h1>Manage Library Sections</h1>
<div id="sectionMessage" class="message"></div>

<!-- Add Section Form -->
<div class="form-container" style="margin-bottom: 2rem;">
    <h2>Add New Section</h2>
    <form id="addSectionForm">
        <div class="form-group">
            <label>Section Name *</label>
            <input type="text" id="sectionName" required placeholder="e.g., Science, History">
        </div>

        <div class="form-group">
            <label>Description *</label>
            <textarea id="sectionDescription" required placeholder="Brief description of this section" rows="3"></textarea>
        </div>

        <button type="submit">Add Section</button>
        <button type="reset" class="btn-secondary">Clear</button>
    </form>
</div>

<!-- Sections List -->
<h2>Existing Sections</h2>
<table id="sectionsTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>Section Name</th>
            <th>Description</th>
            <th>Number of Books</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <tr><td colspan="5" style="text-align: center;">Loading...</td></tr>
    </tbody>
</table>

<!-- Edit Modal (Hidden by default) -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background: white; max-width: 500px; margin: 100px auto; padding: 2rem; border-radius: 5px;">
        <h2>Edit Section</h2>
        <form id="editSectionForm">
            <input type="hidden" id="editSectionId">
            <div class="form-group">
                <label>Section Name *</label>
                <input type="text" id="editSectionName" required>
            </div>
            <div class="form-group">
                <label>Description *</label>
                <textarea id="editSectionDescription" required rows="3"></textarea>
            </div>
            <button type="submit">Update</button>
            <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        async function loadSectionsTable() {
            try {
                const response = await fetch(`${window.API_URL}/sections`);
                const sections = await response.json();

                const tbody = document.querySelector('#sectionsTable tbody');
                tbody.innerHTML = '';

                if (sections.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No sections found</td></tr>';
                    return;
                }

                sections.forEach(section => {
                    const bookCount = section.books ? section.books.length : 0;
                    const row = `
                        <tr>
                            <td>${section.sectionId}</td>
                            <td>${section.sectionName}</td>
                            <td>${section.description || '-'}</td>
                            <td>${bookCount}</td>
                            <td>
                                <button class="action-btn" style="background: #3498db;" onclick="editSection(${section.sectionId}, '${section.sectionName}', '${section.description}')">Edit</button>
                                <button class="action-btn btn-delete" onclick="deleteSection(${section.sectionId}, ${bookCount})">Delete</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                document.querySelector('#sectionsTable tbody').innerHTML =
                    '<tr><td colspan="5" style="text-align: center;">Error loading sections</td></tr>';
            }
        }

        document.getElementById('addSectionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const section = {
                sectionName: document.getElementById('sectionName').value,
                description: document.getElementById('sectionDescription').value
            };

            try {
                const response = await fetch(`${window.API_URL}/sections`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(section)
                });

                if (response.ok) {
                    showMessage('sectionMessage', 'Section added successfully!', 'success');
                    document.getElementById('addSectionForm').reset();
                    loadSectionsTable();
                } else {
                    showMessage('sectionMessage', 'Failed to add section.', 'error');
                }
            } catch (error) {
                showMessage('sectionMessage', 'Error connecting to server.', 'error');
            }
        });

        function editSection(id, name, description) {
            document.getElementById('editSectionId').value = id;
            document.getElementById('editSectionName').value = name;
            document.getElementById('editSectionDescription').value = description;
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        document.getElementById('editSectionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editSectionId').value;
            const section = {
                sectionId: parseInt(id),
                sectionName: document.getElementById('editSectionName').value,
                description: document.getElementById('editSectionDescription').value
            };

            try {
                const response = await fetch(`${window.API_URL}/sections/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(section)
                });

                if (response.ok) {
                    showMessage('sectionMessage', 'Section updated successfully!', 'success');
                    closeEditModal();
                    loadSectionsTable();
                } else {
                    alert('Failed to update section.');
                }
            } catch (error) {
                alert('Error connecting to server.');
            }
        });

        async function deleteSection(id, bookCount) {
            if (bookCount > 0) {
                alert(`Cannot delete section. It contains ${bookCount} book(s). Please remove or reassign books first.`);
                return;
            }

            if (!confirm('Are you sure you want to delete this section?')) return;

            try {
                const response = await fetch(`${window.API_URL}/sections/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('sectionMessage', 'Section deleted successfully!', 'success');
                    loadSectionsTable();
                } else {
                    alert('Failed to delete section.');
                }
            } catch (error) {
                alert('Error connecting to server.');
            }
        }

        loadSectionsTable();
    </script>
}